# Release Notes - v0.13.2

**Release Date:** January 26, 2026

## üî¥ Critical Fix: Linux + Napari Threading Issues

This release addresses critical threading crashes when using czitools with Napari on Linux systems.

## Problem Resolved

**aicspylibczi** library caused crashes when used concurrently with Napari (PyQt) on Linux, affecting:
- CZI file loading in Napari plugins
- Planetable extraction in GUI applications
- Mosaic tile reading with concurrent operations

### Root Cause
- **aicspylibczi** is NOT thread-safe and conflicts with PyQt event loop on Linux
- **pylibCZIrw** is thread-safe but cannot read individual subblocks/tiles

## ‚úÖ New Features

### 1. Safe Mode (Primary Solution) ‚≠ê

Environment variable control to disable problematic library:

```python
import os
os.environ["CZITOOLS_DISABLE_AICSPYLIBCZI"] = "1"

from czitools.read_tools import read_tools
array, metadata = read_tools.read_6darray("file.czi", use_dask=True)
```

**Benefits:**
- 100% stable with Napari on Linux
- No threading conflicts
- No performance loss (dask lazy loading)
- Recommended for all Napari users on Linux

### 2. Thread Locks (Backward Compatibility)

Global RLock protection added to:
- `read_tiles()` function
- `get_planetable()` function

**Note:** May still experience issues with Napari on Linux. Safe mode is recommended.

### 3. Platform Detection & Warnings

Automatic Linux detection with user warnings:
```python
from czitools.utils.napari_helpers import warn_if_unsafe_for_napari
warn_if_unsafe_for_napari()
```

### 4. New Helper Utilities

**src/czitools/utils/napari_helpers.py** (NEW):
- `enable_napari_safe_mode()` - Enable safe mode programmatically
- `is_napari_safe_mode()` - Check safe mode status
- `check_napari_compatibility()` - Verify environment safety
- `get_recommended_read_params()` - Get optimal parameters
- `warn_if_unsafe_for_napari()` - Warning for unsafe conditions

**src/czitools/utils/threading_helpers.py** (NEW):
- `with_aics_lock(func)` - Decorator for thread-safe operations
- `is_napari_safe()` - Check safe mode status
- `warn_if_unsafe_for_napari()` - Linux platform warnings

## üìù Changes

### Modified Files
- **src/czitools/read_tools/read_tools.py** - Added safe mode + thread locks
- **src/czitools/utils/planetable.py** - Added safe mode + thread locks
- **src/czitools/metadata_tools/czi_metadata.py** - Safe mode support
- **README.md** - Added prominent warning section
- **setup.cfg** - Updated version to 0.13.2
- **tox.ini** - Updated test configuration

### New Files
- **src/czitools/utils/threading_helpers.py** - Thread-safety utilities
- **src/czitools/utils/napari_helpers.py** - Napari integration helpers
- **src/czitools/_tests/test_napari_safe_mode.py** - Test suite (7 tests)

### Documentation
- **docs/threading_considerations.md** - Comprehensive threading guide
- **docs/NAPARI_FIX.md** - Quick-fix guide
- **docs/FINAL_SOLUTION.md** - Complete solution documentation
- **docs/IMPLEMENTATION_SUMMARY.md** - Technical details
- **docs/LINUX_NAPARI_PLANETABLE.md** - Linux-specific guide

### Examples
- **demo/scripts/napari_safe_loading.py** - Working example
- **demo/scripts/napari_with_planetable_linux.py** - Linux planetable example
- **demo/scripts/napari_plugin_example.py** - Plugin integration
- **demo/scripts/napari_with_process_isolation.py** - Process isolation pattern

## üöÄ Recommended Usage

### For Linux + Napari Users:
```python
import os
os.environ["CZITOOLS_DISABLE_AICSPYLIBCZI"] = "1"

from czitools.read_tools import read_tools
import napari

array, metadata = read_tools.read_6darray("file.czi", use_dask=True)
viewer = napari.Viewer()
viewer.add_image(array)
```

### For Windows/macOS:
No changes needed - works as before.

### For Planetable Extraction:
Use sequential pattern (extract before Napari):
```python
from czitools.utils.planetable import get_planetable

# Extract planetable BEFORE starting Napari
df, _ = get_planetable("file.czi")

# THEN start Napari
import napari
viewer = napari.Viewer()
```

## üîÑ Backward Compatibility

- ‚úÖ No breaking changes for Windows/macOS users
- ‚úÖ Existing code works without modifications
- ‚úÖ Safe mode is opt-in via environment variable
- ‚úÖ Thread locks provide basic protection by default

## ‚ö†Ô∏è Behavioral Changes

When `CZITOOLS_DISABLE_AICSPYLIBCZI=1` is set:
- `read_tiles()` raises `RuntimeError` (use `read_6darray()` instead)
- `get_planetable()` returns empty DataFrame (extract before Napari)
- `CziMetadata.attachment_info` returns `None`
- All other functionality remains unchanged

## üìä Statistics

- **Total Changes:** 19 files
- **Insertions:** +2,542 lines
- **Deletions:** -396 lines
- **New Tests:** 7 (all passing)
- **New Documentation:** 5 files
- **New Examples:** 4 scripts

## üß™ Testing

All tests passing:
```bash
pytest src/czitools/_tests/test_napari_safe_mode.py -v
```

**Test Coverage:**
- Safe mode enable/disable
- Environment variable detection
- Thread lock functionality
- read_tiles behavior in safe mode
- get_planetable behavior in safe mode
- read_6darray compatibility
- Platform detection

## üìö Documentation

Comprehensive documentation available:
- [Threading Considerations](../docs/threading_considerations.md)
- [Napari Quick Fix](../docs/NAPARI_FIX.md)
- [Final Solution](../docs/FINAL_SOLUTION.md)
- [Linux Guide](../docs/LINUX_NAPARI_PLANETABLE.md)

## üéØ Migration Guide

### If you use `read_6darray()`:
‚úÖ No changes needed! Works perfectly in all modes.

### If you use `read_tiles()` or `get_planetable()` with Napari on Linux:
Enable safe mode and switch to `read_6darray()`:
```python
os.environ["CZITOOLS_DISABLE_AICSPYLIBCZI"] = "1"
array, metadata = read_tools.read_6darray("file.czi")  # Use this instead
```

### If you need planetables with Napari:
Use sequential pattern:
```python
# 1. Extract planetable BEFORE Napari
df, _ = get_planetable("file.czi")

# 2. THEN start Napari
import napari
viewer = napari.Viewer()
```

## üôè Acknowledgments

Thanks to all users who reported threading issues on Linux systems and helped identify the root cause.

## üîó Related

- **Pull Request:** [#111 - Fix threading issues with aicspylibczi on Linux + Napari](https://github.com/sebi06/czitools/pull/111)
- **Branch:** improve_stability

---

For detailed technical information, see the [Implementation Summary](../docs/IMPLEMENTATION_SUMMARY.md).
